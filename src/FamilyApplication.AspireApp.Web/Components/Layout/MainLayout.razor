@using BlazorServerCommon.Login
@using BlazorServerCommon.Vm
@using FamilyApplication.AspireApp.Web.Components.Users
@using FamilyApplication.AspireApp.Web.CosmosDb.User
@using FamilyApplication.AspireApp.Web.Databuffer
@using FamilyApplication.AspireApp.Web.Notifications
@using FamilyApplication.AspireApp.Web.Sessions
@using Microsoft.AspNetCore.Components.Authorization
@using System.Reflection
@attribute [Authorize]
@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
@inject GlobalVm GlobalVm
@inject Users.UserNotificationManager UserNotificationManager
@inject SessionManager SessionManager
@inject IDialogService DialogService
@implements IDisposable
@using Microsoft.FluentUI.AspNetCore.Components.DesignTokens
@inject AccentBaseColor AccentBaseColor
@inject NeutralBaseColor NeutralBaseColor
@inject IJSRuntime JSRuntime
@inject Services.ThemeService ThemeService


<AuthorizeView>
	<Authorized>
		
<div @ref="rootRef">
		<FluentLayout Style="display: flex; flex-direction: column; height: 100vh; overflow: hidden; margin: 0; padding: 0;">
			<FluentHeader>
				<FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
					AppiSnappi
					<FluentSpacer />
					<RunningTaskAndErrorFooterContent />
					<SessionViewer />
					<FluentCounterBadge Count="@UserNotificationManager.UnreadCount"
										ShowWhen="@(Count => Count > 0)"
					BackgroundColor="@Color.Error"
					Color="@Color.Fill">
						<FluentButton IconStart="@(new Icons.Filled.Size16.Alert())" Appearance="Appearance.Lightweight" OnClick="OpenUserNotificationPanel" />
					</FluentCounterBadge>
				</FluentStack>
			</FluentHeader>
			<FluentStack Class="main" Orientation="Orientation.Horizontal" Width="100%">
				<NavMenu />
				<FluentBodyContent Class="body-content">
					<div class="content">
						@Body
					</div>
				</FluentBodyContent>
			</FluentStack>
			<FluentFooter Style="background-color:transparent">
				<p style="margin: 0; color: #666; font-size: 0.8em;">Version: @GetVersion()</p>
			</FluentFooter>
		</FluentLayout>
		</div>
	</Authorized>
	<NotAuthorized>
		<p>Du er ikke logget på. <a href="authentication/login-callback">Logg på</a></p>
	</NotAuthorized>
</AuthorizeView>


<div id="blazor-error-ui" data-nosnippet>
	En megafeil har skjedd.
	<a href="." class="reload">Last på nytt</a>
	<span class="dismiss">🗙</span>
</div>

@code {

	private ElementReference rootRef;
	private DotNetObjectReference<MainLayout>? dotNetHelper;


	protected override async Task OnInitializedAsync()
	{
		ThemeService.ThemeChanged += OnThemeChangedAsync;
	}
	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			await ThemeService.LoadSavedPaletteAsync(); // Initial load (safe here, no JS)
			await ApplyTokensAsync(); // Initial apply
			try
			{
				UserNotificationManager.SomeThingChanged += SomethingHasChanged;
				dotNetHelper = DotNetObjectReference.Create(this);

				// Check if the device is iOS before registering the service worker
				var isIOS = await JSRuntime.InvokeAsync<bool>("isIOS");
				if (!isIOS)
				{
					await JSRuntime.InvokeVoidAsync("registerServiceWorkerMessageHandler", dotNetHelper);
				}
				else
				{
					Console.WriteLine("iOS detected. Service Worker handler not registered.");
				}
			}
			catch
			{
				// ignored
			}
		}
	}
	private string GetVersion()
	{
		return Assembly.GetExecutingAssembly().GetName().Version?.ToString() ?? "Unknown";
	}
	public void Dispose()
	{

		ThemeService.ThemeChanged -= OnThemeChangedAsync;
		UserNotificationManager.SomeThingChanged -= SomethingHasChanged;
	}


	private void SomethingHasChanged(object? sender, EventArgs e)
	{
		this.InvokeAsync(() => this.StateHasChanged());
	}

	private async Task OpenUserNotificationPanel()
	{
		var user = SessionManager.GetMyUserDto();

		var dialog = await DialogService.ShowPanelAsync<UserNotificationPanel>(user, new DialogParameters<UserDto>()
			{
				Content = user,
				Title = "Dine Varsler 🎉",
				Alignment = HorizontalAlignment.Right,
				PrimaryAction = "Lukk",
			  DismissTitle = "Lukk",
			   ShowDismiss = false,
			 SecondaryAction = null
			});

	}
	private async Task OnThemeChangedAsync()
	{
		await ApplyTokensAsync();
		StateHasChanged(); // Re-render for updates
	}

	private async Task ApplyTokensAsync()
	{
		// Set Fluent tokens site-wide via root ref
		await NeutralBaseColor.SetValueFor(rootRef, ThemeService.CurrentNeutral.ToSwatch());
		await AccentBaseColor.SetValueFor(rootRef, ThemeService.CurrentAccent.ToSwatch());

		// Fallback JS for custom app.css vars (e.g., body, non-Fluent styles)
		var cssVars = new Dictionary<string, string>
		{
			{ "neutral-base-color", ThemeService.CurrentNeutral },
			{ "accent-base-color", ThemeService.CurrentAccent }
		};
		await JSRuntime.InvokeVoidAsync("setCssVariables", cssVars);
	}


}